---
name: OpenCourier app beta for IOS CI

on:
  push:
    tags:
      - 'v*'  # Runs only for version tags like v1.0.0
    paths-ignore:
      - .gitignore
      - .github/**
      - '!.github/workflows/beta-android.yaml'  # Run check on self change
      - '**/*_tests/**'
      - '**/CMakeLists.txt'
      - CONTRIBUTORS
      - LICENSE
      - README**.md
      - docs/**
      - misc/**
jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Import Code Signing Certificates
        uses: apple-actions/import-codesigning-certificates@v1
        with:
          p12-file-base64: ${{ secrets.P12_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}
          provisioning-profile-base64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}

      - name: Build iOS App
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -x
          nix develop --impure --command -- make ios-release BUILD_NUMBER=${{ github.run_number }}
      - name: Rename IPA
        run: |
          set -x
          PROJECT_NAME=$(node -p "require('./package.json').name")
          mv ios/build/${PROJECT_NAME}/${PROJECT_NAME}.ipa ${PROJECT_NAME}_${{ github.ref_name }}+${{ github.run_number }}.ipa
      - name: "Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: IPA
          path: "*.ipa"
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.ipa"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
